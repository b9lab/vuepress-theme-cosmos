<template lang="pug">
    img(:src="$withBase(resizedSrc)" :data-zoom-src="$withBase(zoomSrc)")
</template>

<script>
export default {
    props: ['src'],
    data() {
        const parentWidth = this.$parent.$el?.clientWidth || 0;
        const windowWidth = (typeof window !== 'undefined') ? window.innerWidth : 0;
        return {
            resizedSrc: this.getResizedSrc(parentWidth),
            zoomSrc: this.getResizedSrc(windowWidth)
        }
    },
    mounted() {
        this.$nextTick(() => {
            this.resizedSrc = this.getResizedSrc(this.$parent.$el?.clientWidth || 0);
            this.zoomSrc = this.getResizedSrc(window?.innerWidth || 0);
        })
    },
    methods: {
        noResizeNeeded(src) {
            var absoluteRe = /^https?:\/\//i;
            var svgRe = /^.*\.(svg)$/i;
            return (absoluteRe.test(src) || svgRe.test(src));
        },
        getBreakpoint(width) {
            var breakpoint = null;
            var breakpointList = this.$themeConfig?.assetsOptimization?.breakpoints;

            if (width && breakpointList) {
                for (var item of breakpointList) {
                    if (width <= item) {
                        breakpoint = item;
                        break;
                    }
                }
                if (!breakpoint) {
                    breakpoint = breakpointList[breakpointList.length - 1];
                }
            }

            return breakpoint;
        },
        getResizedSrc(width) {
            if (this.noResizeNeeded(this.src)) return this.src;

            const breakpoint = this.getBreakpoint(width);
            if (!breakpoint) return this.src;

            return '/resized-images/' + breakpoint + this.src;
        }
    }
}
</script>
