<template lang="pug">
  .wizard
    .wizard__inner
      transition(name="fade")
        // Step 0
        div(v-if='step === 0' ref='step0' key='step0').tm-grid-base
          .wizard-col
            h4
              label(for='field-email') Get Cosmos updates
            p.mt-3.tm-lh-title.tm-rf-1.tm-medium.tm-muted Unsubscribe at any time.
              | 
              a.tm-link.tm-link-external(href='https://v1.cosmos.network/privacy' target="_blank")
                span Privacy Policy

          .wizard-col
            .form.tm-center
              .form__input
                input#field-email.form__input__input.tm-rf0.tm-lh-copy.tm-title(v-model='email' name='fields[email]' type='email' placeholder='Enter your email' required='required' @keypress.enter='actionGoForwards')
                button.form__input__button(type='submit' :disabled='emailInvalid' @click.prevent='actionGoForwards')
                  span.sr-only Next
                  icon-arrow(type="right").newsletter__input__input__button__icon

        // Step 1
        div(v-if='step === 1' ref='step1' key='step1').tm-grid-base
          .wizard-col._top
            button.tm-link.tm-title.tm-lh-title.tm-medium.tm-rf0(@click.prevent='actionGoBackwards') &larr; Back
            h4.mt-5 Which product updates would you like to receive?
            .signup-graphics
              img(src="/signup-mails.svg")
          
          .wizard-col._top
            .card-checkbox-list
              label.card-checkbox.mb-5(v-for='(topic, i) in topics' :key='topic.title')
                input.card-checkbox__input(tabindex="0" v-model='selected' type="checkbox" :value="topic.title" :id="`selected_${i}`")
                .card-checkbox__icon
                .card-checkbox__container
                  .tm-title.tm-rf0.tm-bold.tm-lh-title {{ topic.title }}
                  .tm-rf-1.tm-lh-copy.mt-3.tm-muted {{ topic.desc }}
            .btns-group.mt-6
              button.tm-button.btn(:disabled='!selected.some((t) => t)' @click.prevent='actionSubscribe') Sign up

        // Step 2
        div(v-if='step === 2' ref='step2' key='step2').tm-grid-base
          .wizard-col._top
            h4
              | Almost there!
              br
              | Confirm your email
            img.success-graphics(src='/success-mails.svg')
          .wizard-col._top
            p.tm-rf0.tm-lh-copy.tm-title
              | You should get a confirmation email for each of your selected
              | interests. Open it up and click
              span ‘Confirm your email’
              | so we can keep you updated.
            p.tm-rf-1.tm-lh-title.tm-text
              | Don&rsquo;t see the confirmation email yet?
            p.tm-rf-1.tm-lh-title.tm-muted
              | It might be in your spam folder.
              br
              | If so, make sure to mark it as &quot;not spam&quot;.
</template>

<script>
import { find, without, last } from "lodash";
import querystring from 'querystring'
import validateEmail from 'email-validator'

export default {
  data() {
    return {
      step: 0,
      email: null,
      selected: [],
      requestURL: 'https://app.mailerlite.com/webforms/submit/o0t6d7',
      commonFormData: {
        'ml-submit': '1',
        ajax: '1',
        guid: '6ca22b31-4124-e926-cf4f-272ff9f44ec3',
      },
      topics: [
        {
          title: 'Ecosystem & Community',
          desc:
            'General news and updates from the Cosmos ecosystem and community.',
          requestURL: 'https://app.mailerlite.com/webforms/submit/o0t6d7',
          callback: 'jQuery18307296239382192573_1594158619276',
          _: '1594158625563',
          groups: '108606610',
        },
        {
          title: 'Tools & Technology',
          desc:
            'Engineering and development updates on Cosmos SDK, Tendermint, IBC and more.',
          requestURL: 'https://app.mailerlite.com/webforms/submit/o0t6d7',
          callback: 'jQuery18307296239382192573_1594158619276',
          _: '1594158625563',
          groups: '108606910',
        },
      ],
    }
  },
  computed: {
    emailInvalid() {
      return !validateEmail.validate(this.email)
    },
  },
  methods: {
    actionGoForwards() {
      this.step += 1
    },
    actionGoBackwards() {
      this.step -= 1
    },
    actionSubmitEmail() {
      if (!this.emailInvalid) {
        if (this.topics.length <= 0) {
          this.actionSubscribe()
          this.step = 2
        } else {
          this.actionGoForwards()
        }
      }
    },
    actionSubscribe() {
      if (this.topics.length <= 0) {
        this.subscribe({
          requestURL: this.requestURL,
          callback: this.callback,
          _: this._,
          'groups[]': this.groups,
        })
      } else {
        this.selected.forEach((topicSelected, i) => {
          if (topicSelected) {
            this.subscribe({
              requestURL: this.topics[i].requestURL,
              callback: this.topics[i].callback,
              _: this.topics[i]._,
              'groups[]': this.topics[i].groups,
            })
          }
        })
      }
      this.actionGoForwards()
    },
    async subscribe(body) {
      const options = {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: querystring.stringify({
          'fields[email]': this.email,
          ...this.commonFormData,
          ...body,
        }),
      }
      await fetch(this.requestURL, options)
    },
  }
};
</script>

<style lang="stylus" scoped>
.fade-enter-active
  transition all .4s ease-out

.fade-leave-active
  position absolute
  top 0
  left 0
  width 100%
  transition all .2s ease-out

.fade-enter
  opacity 0
  transform translateY(.5rem)

.fade-enter-to
  opacity 1
  transform translateY(0)

.fade-leave
  opacity 1
  transform scale(1)

.fade-leave-to
  opacity 0
  transform scale(.96)

.wizard
  position relative
  margin-top var(--spacing-10)
  padding-top var(--spacing-9)
  padding-bottom var(--spacing-9)
  border-bottom 1px solid var(--semi-transparent-color-2)
  &__inner
    max-width 48.5rem
    margin auto

.wizard-col
  position relative
  z-index 1
  display flex
  flex-direction: column
  justify-content center
  height 100%
  grid-column 1/-1
  @media screen and (min-width: 768px)
    grid-column span 4
  @media screen and (min-width: 1200px)
    grid-column: span 6
  &._top
    justify-content flex-start

.title-short
  max-width 42rem
  @media $breakpoint-xl
    max-width 45rem

.title
  max-width 55rem

.form
  width 100%
  margin-top var(--spacing-6)
  @media screen and (min-width: 768px)
    margin-top 0
  &__group
    position relative
  &__input
    display flex
    position relative
    align-items center
    justify-content center
    &__button
      position absolute
      display flex
      align-items center
      justify-content center
      right 0
      width 2.5rem
      appearance none
      background none
      border none
      padding var(--spacing-5)
      border-radius .5rem
      cursor pointer
      outline none
      opacity .8
      transition opacity .15s ease-out, transform .15s ease-out
      @media screen and (min-width: 768px)
        width 3.5rem
      &:hover,
      &:focus
        opacity 1
        transform scale(1.05)
      &:disabled
        opacity 0.65
        pointer-events none
    &__input
      outline none
      width 100%
      height 3rem
      border none
      border-radius .5rem
      padding var(--spacing-3) 4rem var(--spacing-3) var(--spacing-5)
      transition color 0.15s ease-out, background 0.15s ease-out
      background var(--background-color-secondary)
      &::placeholder
        color var(--semi-transparent-color-2)
        transition color 0.15s ease-out
      &:hover
        &:not(:focus)::placeholder
          color var(--semi-transparent-color-3)

.signup-graphics
  position relative
  z-index -1
  margin-top: -6rem

.success-graphics
  position relative
  position relative
  margin-top -2rem

.card-checkbox
  position relative
  overflow hidden
  display block
  background-color var(--background-color-secondary)
  border-radius 1.25rem
  padding 1.95rem
  padding-right 3.45rem
  user-select none
  cursor pointer
  transform none
  transition background-color 0.25s, border-color 0.25s,
    box-shadow 0.15s ease-out, transform 0.15s ease-out
  box-sizing border-box
  outline none
  &:hover
    transform translateY(-2px)
  &:hover,
  &:focus
    box-shadow 0px 12px 24px rgba(0, 0, 0, 0.07), 0px 4px 8px rgba(0, 0, 0, 0.05), 0px 1px 0px rgba(0, 0, 0, 0.05)
    .card-checkbox
      &__icon
        border-color var(--title)
  input
    position absolute
    right 0
    top 0
    width 0
    height 0
    opacity 0
    &:checked
      opacity .1
      ~ .card-checkbox
        &__icon
          border-color var(--muted)
          background-color var(--muted)
          &:after
            opacity 1
  &__icon
    position absolute
    top 1.95rem
    right 1.95rem
    width: 1.5rem
    height: 1.5rem
    border 1px solid var(--muted)
    border-radius 100%
    transition background-color 0.25s, border-color 0.25s
    &:after
      content ''
      position absolute
      opacity 0
      top 0.3rem
      left 0.25rem
      width .8rem
      height .5rem
      border-left 2px solid var(--background-color-secondary)
      border-bottom 2px solid var(--background-color-secondary)
      transition opacity 0.25s
      transform rotate(-45deg)
</style>
